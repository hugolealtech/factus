<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functus v2.1 - Planner Financeiro (Stable)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --danger: #e74c3c;     /* Vermelho - Urgente */
            --warning: #f1c40f;    /* Amarelo - Aten√ß√£o */
            --safe: #2ecc71;       /* Verde - Tranquilo */
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #2c3e50;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Layout */
        header { background: var(--primary); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10; }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        
        main { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        /* Components */
        .card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .row { display: flex; flex-wrap: wrap; gap: 20px; }
        .col { flex: 1; min-width: 300px; }
        
        /* Dashboard Stats */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .stat-box { background: white; padding: 1.2rem; border-radius: 10px; border-left: 5px solid var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #7f8c8d; letter-spacing: 1px; }

        /* Navigation Tabs */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 50px; width: fit-content; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-tab { cursor: pointer; padding: 8px 20px; border-radius: 20px; font-weight: 500; font-size: 0.9rem; transition: 0.3s; }
        .nav-tab:hover { background: #ecf0f1; }
        .nav-tab.active { background: var(--accent); color: white; box-shadow: 0 2px 5px rgba(52, 152, 219, 0.4); }

        /* Month Selector (Planner) */
        .month-selector { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: white; padding: 10px 20px; border-radius: 12px; }
        .month-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary); padding: 0 15px; }
        .current-month-display { font-size: 1.2rem; font-weight: bold; text-transform: capitalize; }

        /* Planner Items */
        .planner-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; border-radius: 8px; margin-bottom: 10px; 
            border-left: 6px solid #ccc; background: white;
            transition: all 0.2s;
        }
        .planner-item:hover { transform: translateX(5px); }
        
        /* Traffic Light Logic */
        .status-safe { border-left-color: var(--safe); }
        .status-warning { border-left-color: var(--warning); background-color: #fffcf0; }
        .status-danger { border-left-color: var(--danger); background-color: #fff5f5; }
        .status-paid { border-left-color: #bdc3c7; background-color: #f9f9f9; opacity: 0.7; text-decoration: line-through; }
        .status-paid .info { opacity: 0.5; }

        .item-info h4 { margin: 0; font-size: 1rem; }
        .item-info small { color: #7f8c8d; font-size: 0.8rem; }
        .item-meta { text-align: right; }
        .item-price { font-weight: bold; font-size: 1.1rem; }
        
        /* Buttons */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--safe); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        .btn:hover { filter: brightness(0.9); transform: translateY(-1px); }

        .btn-pay { min-width: 80px; }

        /* Modal "At√© Quando" */
        .debt-list { max-height: 400px; overflow-y: auto; }
        .debt-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .debt-date { font-weight: bold; color: var(--accent); }

        /* Forms */
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .hidden { display: none !important; }
        
        /* Tags */
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; color: white; font-weight: normal; margin-left: 5px;}
    </style>
</head>
<body>

<header>
    <h1>Functus <span style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:4px;">v2.1</span></h1>
    <div style="display: flex; gap: 10px;">
        <button class="btn btn-outline" style="color:white; border-color:white" onclick="app.showDebtProjection()">‚è≥ At√© quando eu pago?</button>
        <button class="btn btn-success" onclick="app.exportData()">üíæ Backup</button>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">üìÇ Restaurar</button>
        <input type="file" id="fileInput" class="hidden" onchange="app.importData(this)">
    </div>
</header>

<div style="padding: 1rem 2rem 0;">
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="app.switchTab('dashboard')">üìä Dashboard & Gr√°ficos</div>
        <div class="nav-tab" onclick="app.switchTab('planner')">üìÖ Planner Inteligente</div>
        <div class="nav-tab" onclick="app.switchTab('entries')">üìù Lan√ßamentos</div>
        <div class="nav-tab" onclick="app.switchTab('cards')">üí≥ Cart√µes</div>
    </div>
</div>

<main id="main-content">
    </main>

<script>
/**
 * CORE LOGIC - FUNCTUS v2.1
 */

const Utils = {
    uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
    formatCurrency: (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val),
    toDate: (str) => new Date(str + 'T12:00:00'),
    formatMonthYear: (ymStr) => {
        const [y, m] = ymStr.split('-');
        const date = new Date(y, m - 1, 1);
        return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
    },
    addMonths: (date, months) => {
        const d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d;
    },
    diffDays: (d1, d2) => {
        const t1 = new Date(d1).setHours(0,0,0,0);
        const t2 = new Date(d2).setHours(0,0,0,0);
        return (t1 - t2) / (1000 * 60 * 60 * 24);
    },
    getTodayStr: () => new Date().toISOString().split('T')[0]
};

const Store = {
    data: {
        cards: [],
        expenses: [],
        income: [],
        categories: [
            "Alimenta√ß√£o", "Mercado", "√Ågua/Luz/Net", "Tributos/Impostos", 
            "Pets", "Aluguel/Reparos", "Lazer/Sa√≠da", 
            "Viagens", "Material Escolar", "Filhos", "Medicamentos", 
            "Entretenimento (Streaming)", "Escrit√≥rio"
        ],
        beneficiaries: ["Geral", "Hugo", "L√≠via", "Helena", "Nina", "Lilica"]
    },
    
    init() {
        const saved = localStorage.getItem('functus_db_v2');
        if (saved) {
            this.data = JSON.parse(saved);
        } else {
            this.seed();
        }
    },

    save() {
        localStorage.setItem('functus_db_v2', JSON.stringify(this.data));
        // Verifica√ß√£o de seguran√ßa: s√≥ chama render se o app j√° existir
        if (window.app && typeof window.app.render === 'function') {
            window.app.render();
        }
    },

    seed() {
        this.data.cards.push({ id: 'c1', name: 'Mastercard Black', closingDay: 5, dueDay: 10, active: true });
        this.save();
    }
};

const Ledger = {
    getMonthlyLedger(year, month) {
        const targetYM = `${year}-${String(month).padStart(2, '0')}`;
        const items = [];
        let totalDue = 0;
        let totalPaid = 0;

        Store.data.expenses.forEach(exp => {
            const expDate = Utils.toDate(exp.date);
            let startMonthOffset = 0;
            let dueDate = new Date(year, month - 1, expDate.getDate());
            
            if (exp.cardId) {
                const card = Store.data.cards.find(c => c.id === exp.cardId);
                if (card) {
                    if (expDate.getDate() >= card.closingDay) startMonthOffset = 1;
                    dueDate = new Date(year, month - 1, card.dueDay);
                }
            } else {
                dueDate = new Date(year, month - 1, expDate.getDate());
            }

            let isApplicable = false;
            let currentParcel = 0;
            let note = '';
            const totalInstallments = parseInt(exp.installments) || 1;

            if (exp.type === 'recorrente') {
                const expStartYM = exp.date.substring(0, 7);
                if (targetYM >= expStartYM) {
                    isApplicable = true;
                    note = 'Recorrente';
                    currentParcel = 1;
                }
            } else {
                const firstParcelDate = Utils.addMonths(expDate, startMonthOffset);
                const diffMonths = (year - firstParcelDate.getFullYear()) * 12 + (month - 1 - firstParcelDate.getMonth());
                
                if (diffMonths >= 0 && diffMonths < totalInstallments) {
                    isApplicable = true;
                    currentParcel = diffMonths + 1;
                    note = exp.type === 'parcelado' ? `${currentParcel}/${totalInstallments}` : '√Ä vista';
                }
            }

            if (isApplicable) {
                const parcelValue = parseFloat(exp.value) / (exp.type === 'parcelado' ? totalInstallments : 1);
                
                if (!exp.paidPeriods) exp.paidPeriods = [];
                const isPaid = exp.paidPeriods.includes(targetYM);

                if(isPaid) totalPaid += parcelValue;
                else totalDue += parcelValue;

                const today = new Date();
                today.setHours(0,0,0,0);
                const daysToDue = Utils.diffDays(dueDate, today);
                
                let statusColor = 'status-safe';
                if (isPaid) {
                    statusColor = 'status-paid';
                } else {
                    if (daysToDue <= 1) statusColor = 'status-danger';
                    else if (daysToDue <= 5) statusColor = 'status-warning';
                }

                items.push({
                    expenseId: exp.id,
                    description: exp.description,
                    beneficiary: exp.beneficiary,
                    category: exp.category,
                    cardName: exp.cardId ? (Store.data.cards.find(c => c.id === exp.cardId)?.name || 'Cart√£o Exclu√≠do') : 'Dinheiro/Pix',
                    value: parcelValue,
                    note: note,
                    dueDate: dueDate,
                    isPaid: isPaid,
                    statusClass: statusColor,
                    targetYM: targetYM,
                    isQuitado: (exp.type !== 'recorrente' && currentParcel === totalInstallments && isPaid)
                });
            }
        });

        items.sort((a, b) => a.dueDate - b.dueDate);
        return { items, totalDue, totalPaid, total: totalDue + totalPaid };
    },

    togglePayment(expenseId, periodYM) {
        const exp = Store.data.expenses.find(e => e.id === expenseId);
        if (!exp) return;
        if (!exp.paidPeriods) exp.paidPeriods = [];

        if (exp.paidPeriods.includes(periodYM)) {
            exp.paidPeriods = exp.paidPeriods.filter(p => p !== periodYM);
        } else {
            exp.paidPeriods.push(periodYM);
        }
        Store.save();
    },

    getDebtEndDate(exp) {
        if (exp.type === 'recorrente') return 'Indeterminado';
        if (exp.type === 'avista' || exp.type === 'cartao_avista') return Utils.formatDate(exp.date);
        const total = parseInt(exp.installments);
        const endDate = Utils.addMonths(Utils.toDate(exp.date), total);
        return endDate;
    }
};

const App = {
    currentTab: 'dashboard',
    plannerDate: new Date(),

    init() {
        Store.init();
        this.render();
    },

    switchTab(tab) {
        this.currentTab = tab;
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll(`.nav-tab[onclick="app.switchTab('${tab}')"]`).forEach(t => t.classList.add('active'));
        this.render();
    },

    changePlannerMonth(offset) {
        this.plannerDate = Utils.addMonths(this.plannerDate, offset);
        this.render();
    },

    payBill(id, ym) {
        Ledger.togglePayment(id, ym);
    },

    showDebtProjection() {
        const debts = Store.data.expenses.filter(e => e.type === 'parcelado');
        const list = debts.map(d => {
            const end = Ledger.getDebtEndDate(d);
            const endStr = end === 'Indeterminado' ? end : end.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'});
            const total = parseInt(d.installments);
            const paid = d.paidPeriods ? d.paidPeriods.length : 0;
            const status = paid >= total ? '<span style="color:green; font-weight:bold">QUITADO</span>' : '';

            return `
                <div class="debt-item">
                    <div>
                        <strong>${d.description}</strong> (${paid}/${total})<br>
                        <small>${d.category}</small>
                    </div>
                    <div style="text-align:right">
                        <div class="debt-date">Termina em: ${endStr}</div>
                        ${status}
                    </div>
                </div>
            `;
        }).join('');

        const modalHtml = `
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000" onclick="this.remove()">
                <div class="card" style="width:500px; max-width:90%;" onclick="event.stopPropagation()">
                    <h2>At√© quando eu pago?</h2>
                    <div class="debt-list">${list || '<p>Nenhuma d√≠vida parcelada ativa.</p>'}</div>
                    <button class="btn btn-primary" style="margin-top:20px; width:100%" onclick="this.parentElement.parentElement.remove()">Fechar</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    },

    render() {
        const main = document.getElementById('main-content');
        main.innerHTML = '';
        if (this.currentTab === 'dashboard') this.renderDashboard(main);
        if (this.currentTab === 'planner') this.renderPlanner(main);
        if (this.currentTab === 'entries') this.renderEntries(main);
        if (this.currentTab === 'cards') this.renderCards(main);
    },

    renderDashboard(container) {
        const today = new Date();
        const ledger = Ledger.getMonthlyLedger(today.getFullYear(), today.getMonth() + 1);

        container.innerHTML = `
            <div class="row">
                <div class="col">
                    <div class="card">
                        <h2>Vis√£o do M√™s (${Utils.formatMonthYear(today.toISOString().slice(0,7))})</h2>
                        <div class="stat-grid">
                            <div class="stat-box">
                                <div class="stat-val" style="color:var(--danger)">${Utils.formatCurrency(ledger.totalDue)}</div>
                                <div class="stat-label">A Pagar</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-val" style="color:var(--safe)">${Utils.formatCurrency(ledger.totalPaid)}</div>
                                <div class="stat-label">J√° Pago</div>
                            </div>
                        </div>
                        <p style="text-align:center; color:#7f8c8d">Use o <b>Planner Inteligente</b> para ver detalhes e dar baixa.</p>
                    </div>
                </div>
                <div class="col">
                    <div class="card">
                         <h3>M√©dia de Gastos por Item</h3>
                         <canvas id="chartItems"></canvas>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-top:20px">
                <div class="col">
                    <div class="card">
                        <h3>Distribui√ß√£o por Categoria</h3>
                        <canvas id="chartCategories" style="max-height:300px"></canvas>
                    </div>
                </div>
            </div>
        `;
        this.renderCharts();
    },

    renderCharts() {
        const expenses = Store.data.expenses;
        const catMap = {};
        expenses.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + parseFloat(e.value); });
        const benMap = {};
        expenses.forEach(e => { benMap[e.beneficiary] = (benMap[e.beneficiary] || 0) + parseFloat(e.value); });

        new Chart(document.getElementById('chartCategories'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(catMap),
                datasets: [{
                    data: Object.values(catMap),
                    backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#34495e', '#e67e22']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        new Chart(document.getElementById('chartItems'), {
            type: 'bar',
            data: {
                labels: Object.keys(benMap),
                datasets: [{
                    label: 'Total Acumulado',
                    data: Object.values(benMap),
                    backgroundColor: '#3498db'
                }]
            },
            options: { responsive: true }
        });
    },

    renderPlanner(container) {
        const y = this.plannerDate.getFullYear();
        const m = this.plannerDate.getMonth() + 1;
        const ledger = Ledger.getMonthlyLedger(y, m);
        const currentYM = `${y}-${String(m).padStart(2,'0')}`;

        const itemsHtml = ledger.items.map(item => `
            <div class="planner-item ${item.statusClass}">
                <div class="item-info">
                    <h4>
                        ${item.description} 
                        <span class="tag" style="background:${item.isPaid ? '#95a5a6' : '#3498db'}">${item.note}</span>
                        ${item.isQuitado ? '<span class="tag" style="background:#27ae60">QUITADO TOTAL</span>' : ''}
                    </h4>
                    <small>Vence: ${item.dueDate.getDate()}/${item.dueDate.getMonth()+1} ‚Ä¢ ${item.cardName} ‚Ä¢ ${item.category} (${item.beneficiary})</small>
                </div>
                <div class="item-meta">
                    <div class="item-price">${Utils.formatCurrency(item.value)}</div>
                    <button class="btn ${item.isPaid ? 'btn-outline' : 'btn-success'} btn-pay" 
                            onclick="app.payBill('${item.expenseId}', '${item.targetYM}')">
                        ${item.isPaid ? 'Desfazer' : 'PAGO'}
                    </button>
                </div>
            </div>
        `).join('');

        container.innerHTML = `
            <div class="card full-width">
                <div class="month-selector">
                    <button class="month-btn" onclick="app.changePlannerMonth(-1)">&#8249;</button>
                    <div class="current-month-display">
                        ${Utils.formatMonthYear(currentYM)}
                        <div style="font-size:0.9rem; font-weight:normal; color:#7f8c8d; text-align:center">
                            Total: ${Utils.formatCurrency(ledger.total)}
                        </div>
                    </div>
                    <button class="month-btn" onclick="app.changePlannerMonth(1)">&#8250;</button>
                </div>

                <div class="planner-list">
                    ${itemsHtml.length ? itemsHtml : '<p style="text-align:center; padding:20px; color:#999">Nenhuma conta para este m√™s. Voc√™ venceu a entropia!</p>'}
                </div>
            </div>
        `;
    },

    renderEntries(container) {
        const activeCards = Store.data.cards.filter(c => c.active);
        const cardOptions = activeCards.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        const catOptions = Store.data.categories.map(c => `<option value="${c}">${c}</option>`).join('');
        const benOptions = Store.data.beneficiaries.map(b => `<option value="${b}">${b}</option>`).join('');
        
        container.innerHTML = `
            <div class="card">
                <h3>Novo Lan√ßamento</h3>
                <form onsubmit="app.handleAddExpense(event)">
                    <div class="row">
                        <div class="col"><label>Descri√ß√£o</label><input type="text" name="desc" required></div>
                        <div class="col"><label>Valor Total</label><input type="number" step="0.01" name="value" required></div>
                    </div>
                    <div class="row">
                        <div class="col"><label>Categoria</label><select name="category">${catOptions}</select></div>
                        <div class="col"><label>Benefici√°rio</label><select name="beneficiary">${benOptions}</select></div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Tipo</label>
                            <select name="type" onchange="app.toggleInstallments(this.value)">
                                <option value="avista">√Ä vista / Pix</option>
                                <option value="cartao_avista">Cart√£o (1x)</option>
                                <option value="parcelado">Parcelado</option>
                                <option value="recorrente">Recorrente</option>
                            </select>
                        </div>
                        <div class="col hidden" id="card-selection">
                            <label>Cart√£o</label><select name="cardId">${cardOptions}</select>
                        </div>
                    </div>
                    <div class="row hidden" id="installment-area">
                        <div class="col"><label>Parcelas</label><input type="number" name="installments" value="1"></div>
                    </div>
                    <label>Data Compra</label><input type="date" name="date" required value="${Utils.getTodayStr()}">
                    <button type="submit" class="btn btn-primary" style="width:100%">Lan√ßar na Contabilidade</button>
                </form>
            </div>
        `;
    },

    renderCards(container) {
        container.innerHTML = `
             <div class="card">
                <h3>Gerenciar Cart√µes</h3>
                <form onsubmit="app.handleAddCard(event)">
                    <div class="row">
                        <div class="col"><input type="text" name="name" placeholder="Nome do Cart√£o" required></div>
                        <div class="col"><input type="number" name="closing" placeholder="Dia Fechamento" required></div>
                        <div class="col"><input type="number" name="due" placeholder="Dia Vencimento" required></div>
                        <div class="col"><button type="submit" class="btn btn-primary">Adicionar</button></div>
                    </div>
                </form>
            </div>
            <div class="row">
                ${Store.data.cards.map(c => `
                    <div class="col" style="flex:0 0 300px">
                        <div class="card" style="border-left:5px solid ${c.active ? 'var(--accent)' : '#ccc'}">
                            <h4>${c.name}</h4>
                            <p>Fecha dia ${c.closingDay} ‚Ä¢ Vence dia ${c.dueDay}</p>
                            <button class="btn ${c.active ? 'btn-danger' : 'btn-success'}" onclick="app.toggleCardStatus('${c.id}', ${!c.active})">
                                ${c.active ? 'Desativar' : 'Restaurar'}
                            </button>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    },

    toggleInstallments(type) {
        document.getElementById('card-selection').classList.toggle('hidden', !type.includes('cartao') && type !== 'parcelado');
        document.getElementById('installment-area').classList.toggle('hidden', type !== 'parcelado');
    },

 handleAddExpense(e) {
        e.preventDefault();
        const f = e.target;
        
        // CORRE√á√ÉO: Pegamos o VALOR do campo tipo antes de usar
        const tipoSelecionado = f.type.value; 

        Store.data.expenses.push({
            id: Utils.uuid(),
            description: f.desc.value,
            value: f.value.value,
            type: tipoSelecionado, 
            category: f.category.value,
            beneficiary: f.beneficiary.value,
            date: f.date.value,
            installments: f.installments ? f.installments.value : 1,
            paidPeriods: [], 
            // AQUI ESTAVA O ERRO: Agora usamos a vari√°vel com o texto correto
            cardId: (tipoSelecionado.includes('cartao') || tipoSelecionado === 'parcelado') ? f.cardId.value : null
        });
        Store.save();
        alert('Lan√ßamento realizado!');
        f.reset();
    },



    handleAddCard(e) {
        e.preventDefault();
        const f = e.target;
        Store.data.cards.push({ id: Utils.uuid(), name: f.name.value, closingDay: parseInt(f.closing.value), dueDay: parseInt(f.due.value), active: true });
        Store.save();
    },

    toggleCardStatus(id, status) {
        const c = Store.data.cards.find(x => x.id === id);
        if(c) { c.active = status; Store.save(); }
    },

    exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(Store.data));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "functus_v2_backup.json"; a.click();
    },

    importData(input) {
        const reader = new FileReader();
        reader.onload = (e) => { Store.data = JSON.parse(e.target.result); Store.save(); location.reload(); };
        reader.readAsText(input.files[0]);
    }
};

// --- CORRE√á√ÉO DO ERRO DE REFER√äNCIA ---
// Atribu√≠mos o objeto App √† vari√°vel global 'window.app' ANTES de iniciar.
// Isso garante que os 'onclick' do HTML e o Store.save() encontrem o 'app'.
window.app = App;
App.init();

</script>
</body>
</html>